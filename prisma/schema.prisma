generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum VerificationState {
  PENDING
  ACCEPTED
  REJECTED
}

model User {
  id           String @id @default(uuid()) @db.Uuid
  email        String @unique
  passwordHash String @map("password_hash")
  name         String @unique
  phone        String // TIDAK Sesuai

  birthDate  DateTime? @map("birth_date") @db.Date
  birthPlace String?   @map("birth_place")
  nik        String?

  hasKtp     Boolean @default(false) @map("has_ktp")
  hasProfile Boolean @default(false) @map("has_profile")

  verificationState            VerificationState @default(PENDING) @map("verification_state")
  verificationStateChangedTime DateTime?         @map("verification_state_changed_time")

  products      Product[]
  carts         Cart[]
  userAddresses UserAddress[]

  outMessages ChatMessage[] @relation(name: "chat_message_from_user")
  inMessages  ChatMessage[] @relation(name: "chat_message_to_user")

  isAdmin Boolean @default(false) @map("is_admin")

  @@map("users")
}

model UserAddress {
  id      String @id @default(uuid()) @db.Uuid
  name    String
  address String

  userId String @map("user_id") @db.Uuid

  user  User   @relation(fields: [userId], references: [id])
  rents Rent[]

  @@unique([id, userId])
  @@map("user_addresses")
}

model Product {
  id         String @id @default(uuid()) @db.Uuid
  name       String
  price      Int
  descripton String @default("")
  stock      Int

  userId     String  @db.Uuid
  categoryId String? @map("category_id") @db.Uuid

  user     User             @relation(fields: [userId], references: [id])
  category ProductCategory? @relation(fields: [categoryId], references: [id])
  rents    Rent[]

  @@map("products")
}

model ProductCategory {
  id       String    @id @default(uuid()) @db.Uuid
  name     String    @unique
  products Product[]

  @@map("product_categories")
}

// RELASI Salah
model Cart {
  id String @id @default(uuid()) @db.Uuid

  userId    String  @map("user_id") @db.Uuid
  paymentId String? @map("payment_id") @db.Uuid

  user    User     @relation(fields: [userId], references: [id])
  rents   Rent[]
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@map("carts")
}

enum RequestState {
  PENDING
  ACCEPTED
  REJECTED
}

// RELASI SALAH
model Rent {
  id          String    @id @default(uuid()) @db.Uuid
  startDate   DateTime? @map("start_date") @db.Date
  durationDay Int       @map("duration_day")
  rentPrice   Int?      @map("rent_price")
  needDeliver Boolean   @map("need_deliver")

  deliverAddressId String? @map("deliver_address_id") @db.Uuid
  productId        String  @map("product_id") @db.Uuid
  cartId           String  @map("cart_id") @db.Uuid

  product        Product      @relation(fields: [productId], references: [id])
  cart           Cart         @relation(fields: [cartId], references: [id])
  deliverAddress UserAddress? @relation(fields: [deliverAddressId], references: [id])

  requestState RequestState @default(PENDING)
  rentReturn   RentReturn?

  @@map("rents")
}

model RentReturn {
  rentId       String       @id @map("rent_id") @db.Uuid
  date         DateTime     @db.Date
  denda        Int?
  requestState RequestState @default(PENDING)

  paymentId String? @db.Uuid

  rent    Rent     @relation(fields: [rentId], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@map("rent_returns")
}

model Payment {
  id     String  @id @default(uuid()) @db.Uuid
  amount Int
  isPaid Boolean @map("is_paid")

  carts       Cart[]
  rentReturns RentReturn[]

  @@map("payments")
}

model ChatMessage {
  id      String   @id @default(uuid()) @db.Uuid
  fromId  String   @map("from_id") @db.Uuid
  toId    String   @map("to_id") @db.Uuid
  date    DateTime @default(now())
  message String

  fromUser User @relation(name: "chat_message_from_user", fields: [fromId], references: [id])
  toUser   User @relation(name: "chat_message_to_user", fields: [toId], references: [id])

  @@map("chat_messages")
}
